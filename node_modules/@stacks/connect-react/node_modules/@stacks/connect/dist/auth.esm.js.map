{"version":3,"file":"auth.esm.js","sources":["../src/auth.ts"],"sourcesContent":["import { AppConfig, UserSession } from '@stacks/auth';\nimport { decodeToken } from 'jsontokens';\nimport type { AuthOptions, AuthResponsePayload } from './types';\n\nimport { getStacksProvider } from './utils';\n\nexport const defaultAuthURL = 'https://app.blockstack.org';\n\nconst version = __VERSION__;\n\nif (typeof window !== 'undefined') {\n  window.__CONNECT_VERSION__ = version;\n}\n\nexport const isMobile = () => {\n  const ua = navigator.userAgent;\n  if (/android/i.test(ua)) {\n    return true;\n  }\n  if (/iPad|iPhone|iPod/.test(ua)) {\n    return true;\n  }\n  return /windows phone/i.test(ua);\n};\n\n/**\n * mobile should not use a 'popup' type of window.\n */\nexport const shouldUsePopup = () => {\n  return !isMobile();\n};\n\nexport const getOrCreateUserSession = (userSession?: UserSession): UserSession => {\n  if (!userSession) {\n    const appConfig = new AppConfig(['store_write'], document.location.href);\n    userSession = new UserSession({ appConfig });\n  }\n  return userSession;\n};\n\nexport const authenticate = async (authOptions: AuthOptions) => {\n  const provider = getStacksProvider();\n  if (!provider) {\n    throw new Error('Unable to authenticate without Hiro Wallet extension');\n  }\n\n  const {\n    redirectTo = '/',\n    manifestPath,\n    onFinish,\n    onCancel,\n    sendToSignIn = false,\n    userSession: _userSession,\n    appDetails,\n  } = authOptions;\n  const userSession = getOrCreateUserSession(_userSession);\n  if (userSession.isUserSignedIn()) {\n    userSession.signUserOut();\n  }\n  const transitKey = userSession.generateAndStoreTransitKey();\n  const authRequest = userSession.makeAuthRequest(\n    transitKey,\n    `${document.location.origin}${redirectTo}`,\n    `${document.location.origin}${manifestPath}`,\n    userSession.appConfig.scopes,\n    undefined,\n    undefined,\n    {\n      sendToSignIn,\n      appDetails,\n      connectVersion: version,\n    }\n  );\n\n  try {\n    const authResponse = await provider.authenticationRequest(authRequest);\n    await userSession.handlePendingSignIn(authResponse);\n    const token = decodeToken(authResponse);\n    const payload = token?.payload;\n    const authResponsePayload = payload as unknown as AuthResponsePayload;\n    onFinish?.({\n      authResponse,\n      authResponsePayload,\n      userSession,\n    });\n  } catch (error) {\n    console.error('[Connect] Error during auth request', error);\n    onCancel?.();\n  }\n};\n\n// eslint-disable-next-line @typescript-eslint/require-await\nexport const getUserData = async (userSession?: UserSession) => {\n  userSession = getOrCreateUserSession(userSession);\n  if (userSession.isUserSignedIn()) {\n    return userSession.loadUserData();\n  }\n  if (userSession.isSignInPending()) {\n    return userSession.handlePendingSignIn();\n  }\n  return null;\n};\n"],"names":["defaultAuthURL","version","__VERSION__","window","__CONNECT_VERSION__","isMobile","ua","navigator","userAgent","test","shouldUsePopup","getOrCreateUserSession","userSession","appConfig","AppConfig","document","location","href","UserSession","authenticate","authOptions","provider","getStacksProvider","Error","redirectTo","manifestPath","onFinish","onCancel","sendToSignIn","_userSession","appDetails","isUserSignedIn","signUserOut","transitKey","generateAndStoreTransitKey","authRequest","makeAuthRequest","origin","scopes","connectVersion","authenticationRequest","authResponse","handlePendingSignIn","token","decodeToken","payload","authResponsePayload","error","getUserData","loadUserData","isSignInPending"],"mappings":";;;;;IAMaA,iBAAiB;AAE9B,IAAMC,UAAUC;AAEhB,IAAI,OAAOC,WAAW,aAAa;SAC1BC,sBAAsBH;AAAA;IAGlBI,WAAW,SAAXA,WAAiB;MACtBC,KAAKC,UAAUC;MACjB,WAAWC,KAAKH,KAAK;WAChB;;MAEL,mBAAmBG,KAAKH,KAAK;WACxB;;SAEF,iBAAiBG,KAAKH;AAAA;IAMlBI,iBAAiB,SAAjBA,iBAAuB;SAC3B,CAACL;AAAA;IAGGM,yBAAyB,SAAzBA,uBAA0BC,aAA2C;MAC5E,CAACA,aAAa;QACVC,YAAY,IAAIC,UAAU,CAAC,gBAAgBC,SAASC,SAASC;kBACrD,IAAIC,YAAY;MAAEL,WAAAA;;;SAE3BD;AAAA;IAGIO;qFAAe,iBAAOC;;;;;UAC3BC,WAAWC;cACZD;;;;gBACG,IAAIE,MAAM;;kCAWdH,YAPFI,YAAAA,gDAAa,6BACbC,eAMEL,YANFK,cACAC,WAKEN,YALFM,UACAC,WAIEP,YAJFO,kCAIEP,YAHFQ,cAAAA,kDAAe,+BACFC,eAEXT,YAFFR,aACAkB,aACEV,YADFU;UAEIlB,cAAcD,uBAAuBkB;cACvCjB,YAAYmB,kBAAkB;wBACpBC;;UAERC,aAAarB,YAAYsB;UACzBC,cAAcvB,YAAYwB,gBAC9BH,iBACGlB,SAASC,SAASqB,SAASb,iBAC3BT,SAASC,SAASqB,SAASZ,cAC9Bb,YAAYC,UAAUyB,QACtB,QACA,QACA;YACEV,cAAAA;YACAE,YAAAA;YACAS,gBAAgBtC;;;;iBAKSoB,SAASmB,sBAAsBL;;UAApDM;;iBACA7B,YAAY8B,oBAAoBD;;UAChCE,QAAQC,YAAYH;UACpBI,UAAUF,yBAAAA,MAAOE;UACjBC,sBAAsBD;+CACjB;YACTJ,cAAAA;YACAK,qBAAAA;YACAlC,aAAAA;;;;;;;kBAGMmC,MAAM;;;;;;;;kBA9CL5B;;;;IAoDA6B;sFAAc,kBAAOpC;;;;wBAClBD,uBAAuBC;eACjCA,YAAYmB;;;;4CACPnB,YAAYqC;;eAEjBrC,YAAYsC;;;;4CACPtC,YAAY8B;;4CAEd;;;;;;;kBARIM;;;;;;;"}